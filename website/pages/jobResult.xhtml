<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<!-- /*
 The Broad Institute
 SOFTWARE COPYRIGHT NOTICE AGREEMENT
 This software and its documentation are copyright (2003-2009) by the
 Broad Institute/Massachusetts Institute of Technology. All rights are
 reserved.
 
 This software is supplied without any warranty or guaranteed support
 whatsoever. Neither the Broad Institute nor MIT can be responsible for its
 use, misuse, or functionality.
 */ -->

<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:fn="http://java.sun.com/jsp/jstl/functions"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:t="http://myfaces.apache.org/tomahawk"
	xmlns:c="http://java.sun.com/jstl/core">
<ui:composition template="/templates/common.xhtml">
	<ui:define name="pageTitle">
		GenePattern | Job #{jobStatusBean.jobInfo.jobNumber}
	</ui:define>
	<ui:define name="headText">
		<script type="text/javascript" src="#{facesContext.externalContext.requestContextPath}/lytebox/lytebox.js" />
		<link href="#{facesContext.externalContext.requestContextPath}/lytebox/lytebox.css"	rel="stylesheet" type="text/css" />
	
		<link href="#{facesContext.externalContext.requestContextPath}/css/GP_DK.css" rel="stylesheet" type="text/css" />
		<!-- Dependency -->
		<script src="http://yui.yahooapis.com/2.7.0/build/yahoo/yahoo-min.js"></script>
		
		<!-- Used for Custom Events and event listener bindings -->
		<script src="http://yui.yahooapis.com/2.7.0/build/event/event-min.js"></script>
		
		<!-- Source file -->
		<script src="http://yui.yahooapis.com/2.7.0/build/connection/connection-min.js"></script>
			
		<script type="text/javascript">
		
		var openVisualizers = #{jobStatusBean.openVisualizers};
		
		/* <![CDATA[ */	
			function toggle(id, openLabel, closedLabel) {
				var open = !(document.getElementById(id).style.display == 'none');
				document.getElementById(id).style.display = open ? 'none' : '';
				if (openLabel) {
					document.getElementById(id + "Label").innerHTML = open ? closedLabel : openLabel;
				}
			}
			
			function openLyteBox(jobNumber) {
				var a = document.createElement("a");
				a.href = '#{facesContext.externalContext.requestContextPath}/pages/jobPermissions.jsf?jobNumber='+jobNumber;
				a.rel = "lyteframe";
				a.title = 'setting permissions for Job #' + jobNumber;
				a.rev = "width: 500px; height: 300px; scrolling: auto, background=";
				myLytebox.start( a, false, true);
			}
			
			function closeLyteBox(jobNumber, isPrivate) {
				var image = document.getElementById('permissionsIcon');
				image.src = isPrivate ? '/gp/images/lock.gif' : '/gp/images/lockOpen.gif';
				myLytebox.end();
			}
			
			var handleUpdateSuccess = function(o){
				if(o.responseText !== undefined){
					var data = eval('(' + o.responseText + ')');
					var status = data.status;
					var jobNumber = data.jobNumber;
					updateStatus(data, status);
					if (status != 'Finished' && status != 'Error') {
						setTimeout("updatePage();", 2500);
					} else {
						updateOutputFiles(data, data.outputParams);
					}
					if (data.isPipeline && data.children) {
						updateChildren(data.children);
					}
				}
			}
			
			var handleUpdateFailure = function(o){
				setTimeout("updatePage();", 2500);
			}
			
			var updateCallback =
			{
			  success: handleUpdateSuccess,
			  failure: handleUpdateFailure
			  
			};
			
			function updatePage() {
				var request = YAHOO.util.Connect.asyncRequest('GET', '#{jobStatusBean.jobInfo.jobNumber}?returnType=JSON', updateCallback);
			} 
			
			function updateChildren(children) {
				for (var i = 0; i < children.length; i++) {
					if (document.getElementById("jobTable"+children[i].jobNumber)) {
						updateChild(children[i]);
					} else {
						//createChild(children[i], i+1);
					}
				}	
			}
			
			function createRegularTable(id, className) {
				var table = document.createElement('table');
				table.id = id;
				table.className = className;
				table.cellpadding = '0';
				table.cellspacing = '0';
				table.border = '0';
				return table;
			}
			
			
			
			function updateChild(child) {
				var status = document.getElementById("jobStatus"+child.jobNumber).innerHTML;
				if (status == 'Processing' && child.status != 'Processing') {
					updateOutputFiles(child, child.outputParams);
				}
				updateStatus(child, child.status);
			}
			
			function updateStatus(job, status) {
				document.getElementById("jobStatusIcon"+job.jobNumber).src = (status == 'Error' ? "/gp/images/error.gif" : (status == 'Finished' ? (job.isVisualizer ? "/gp/images/visualizer.gif" : "/gp/images/complete.gif") : "/gp/images/spin.gif"));
				document.getElementById("jobStatus"+job.jobNumber).innerHTML = status;
				// if there's an indicator cell, update it
				if (document.getElementById("indicatorCell"+job.jobNumber)) {
					var indicatorCell = document.getElementById("indicatorCell"+job.jobNumber);
					indicatorCell.className = status == 'Error' ? "red" : (status == 'Finished' ? "blue" : "green");
				}
			}
			
			function addSpacer(element) {
				addImage(element, "/gp/images/blank.gif");
			}
			
			function addImage(element, src) {
				var image = document.createElement("img");
				image.src = src;
				element.appendChild(image);
				return image;
			}
			
			
			var visualizerAppletTags = new Array();
			
			function updateOutputFiles(job, outputFiles) {
				var div = document.getElementById("outputFilesDiv"+job.jobNumber);
				if (outputFiles) {											
					for (var i = 0; i < outputFiles.length; i++) {
						var p = document.createElement("p");
						p.className = 'narrow';
						for (var i = 0; i < job.numAncestors; i++) {
							addSpacer(p);
						}
						var image = document.createElement("img");
						image.src = "/gp/images/outputFile.gif";
						p.appendChild(image);
						var link = document.Element("a");
						link.style.color = '#0066FF';
						link.href = outputFiles[i].link;
						link.appendChild(document.createTextNode(outputFiles[i].name));
						p.appendChild(link);
						div.appendChild(p);
				    }
				} else if (job.isVisualizer) {
					var p = document.createElement("p");
					p.className = 'narrow';
					for (var i = 0; i < job.numAncestors; i++) {
						addSpacer(p);
					}
					var link = document.createElement('a');
					link.href = 'javascript:this.runVisualizer(' + job.jobNumber + ')';
					visualizerAppletTags[job.jobNumber] = job.visualizerAppletTag;
					var img = document.createElement('img');
					img.border = '0';
					img.src = '/gp/images/visualizer.gif';
					link.appendChild(img);
					link.appendChild(document.createTextNode(' Open Visualizer'));
					p.appendChild(link);
					div.appendChild(p);
					var span = document.createElement('span');
					span.id = 'visualizerSpan' + job.jobNumber;
					div.appendChild(span);
					if (openVisualizers) {
						runVisualizer(job.jobNumber);						
					}
				}
			}
			
			function runVisualizer(jobNumber) {
				document.getElementById("visualizerSpan" + jobNumber).innerHTML = visualizerAppletTags[jobNumber];
			}
			
		/* ]]> */
			
			<h:outputText rendered="#{jobStatusBean.jobInfo.status != 'Finished' and jobStatusBean.jobInfo.status != 'Error'}">
				YAHOO.util.Event.addListener(window, "load", function() { 
					setTimeout("updatePage();", 2500);
				});
			</h:outputText>
			
		</script>
	</ui:define>

	<ui:define name="body">

		<div class="statusReport">
		<div style="text-align:right;">
			To launch visualizer click <img src="/gp/images/visualizer.gif" /> icon. To see options click <img src="/gp/images/smallOptions.gif" /> icon. For Input Parameters click <img src="/gp/images/smallParameters.gif" /> icon.</div> <br />
			<div class="icon">
				<a style="color:#0066FF;" href="javascript:openLyteBox(#{jobStatusBean.jobInfo.jobNumber})">
				<img id="permissionsIcon" src="/gp/images/lockOpen.gif" align="left" />
				Access<br />Permission</a>
			</div>
		
		<div style="float:right;margin-right:10px;"><input type="checkbox" /> Email Reminder</div>
		<div style="float:right;margin-right:10px;"><input type="checkbox" /> Show Execution Logs</div>
		<br /><br />

		<table class="title" cellpadding="0" cellspacing="0" border="0" id="jobTable#{jobStatusBean.jobInfo.jobNumber}">
			<tr>
				<td class="title">
					#{jobStatusBean.jobInfo.jobNumber}.#{jobStatusBean.jobInfo.taskName} 
					<img src="/gp/images/smallOptions.gif"
		                 name="Image2_#{jobStatusBean.jobInfo.jobNumber}" border="0" align="top"
		                 id="Image2_#{jobStatusBean.jobInfo.jobNumber}" onclick="pm_showMenu('menuDiv_#{jobStatusBean.jobInfo.jobNumber}', Position.cumulativeOffset(this), 50, 50);"
		                 onmouseover="MM_swapImage('Image2_#{jobStatusBean.jobInfo.jobNumber}','','/gp/images/smallOptions2.gif',1)"
		                 onmouseout="MM_swapImgRestore();"/>
				</td>
				<td>
					<h:outputText rendered="#{not empty jobStatusBean.jobInfo.inputParameters}">
			    		<div class="icon2"><table cellpadding="0" border="0" cellspacing="0"><tr><td><a href="javascript:toggle('inputParamsDiv#{jobStatusBean.jobInfo.jobNumber}', 'Hide', 'Show');"><img src="/gp/images/parameters.gif" align="left" /></a></td><td><a style="color:#0066FF;" href="javascript:toggle('inputParamsDiv#{jobStatusBean.jobInfo.jobNumber}', 'Hide', 'Show');"><span id="inputParamsDiv#{jobStatusBean.jobInfo.jobNumber}Label">Show</span> Input <br/>Parameters</a></td></tr></table></div>
			    	</h:outputText>
			    </td>
				<td width="30px">
					<h:outputText rendered="#{jobStatusBean.jobInfo.status != 'Finished' and jobStatusBean.jobInfo.status != 'Error'}">
						<img src="/gp/images/spin.gif" id="jobStatusIcon#{jobStatusBean.jobInfo.jobNumber}"/>
					</h:outputText>
					<h:outputText rendered="#{jobStatusBean.jobInfo.status == 'Finished' and jobStatusBean.jobInfo.visualizer}">
						<img src="/gp/images/visualizer.gif" id="jobStatusIcon#{jobStatusBean.jobInfo.jobNumber}"/>
					</h:outputText>
					<h:outputText rendered="#{jobStatusBean.jobInfo.status == 'Finished' and not jobStatusBean.jobInfo.visualizer}">
						<img src="/gp/images/complete.gif" id="jobStatusIcon#{jobStatusBean.jobInfo.jobNumber}"/>
					</h:outputText>
					<h:outputText rendered="#{jobStatusBean.jobInfo.status == 'Error'}">
						<img src="/gp/images/error.gif" border="0" id="jobStatusIcon#{jobStatusBean.jobInfo.jobNumber}"/>
					</h:outputText>
					<span id="jobStatus#{jobStatusBean.jobInfo.jobNumber}" style="display: none;">#{jobStatusBean.jobInfo.status}</span>
				</td>
			</tr>
		</table>

		<h:outputText rendered="#{jobStatusBean.jobInfo.pipeline}">
			<ui:include src="jobStatus_indicator.xhtml">
		    	<ui:param name="jobInfo" value="#{jobStatusBean.jobInfo}" />
		    </ui:include>
		</h:outputText>

		<ui:include src="jobStatus_inputParams.xhtml">
	    	<ui:param name="jobInfo" value="#{jobStatusBean.jobInfo}" />
	    </ui:include>

		<ui:include src="jobStatus_files.xhtml">
	    	<ui:param name="jobInfo" value="#{jobStatusBean.jobInfo}" />
	    	<ui:param name="indent" value="#{false}" />
	    	<ui:param name="openVisualizers" value="#{jobStatusBean.openVisualizers}" />
	    </ui:include>
	    <h:form>
		    <ui:include src="jobStatus_menu.xhtml">
		    	<ui:param name="jobInfo" value="#{jobStatusBean.jobInfo}" />
		    </ui:include>
	    </h:form>
	    <t:dataList var="p" value="#{jobStatusBean.jobInfo.outputFiles}">
	 		<h:form>
	   			<ui:include src="jobStatus_fileMenu.xhtml">
	        		<ui:param name="jobNumber" value="#{jobStatusBean.jobInfo.jobNumber}"/>
	       			<ui:param name="valueId" value="#{p.valueId}"/>
	       			<ui:param name="value" value="#{p.link}"/>
	       			<ui:param name="deleteAllowed" value="#{false}"/>
	   			</ui:include>
	  		</h:form>
	  	</t:dataList>
	  	<t:dataList var="p" value="#{jobStatusBean.jobInfo.inputFiles}">
	 		<h:form>
	   			<ui:include src="jobStatus_fileMenu.xhtml">
	        		<ui:param name="jobNumber" value="#{jobStatusBean.jobInfo.jobNumber}"/>
	       			<ui:param name="valueId" value="#{p.valueId}"/>
	       			<ui:param name="value" value="#{p.link}"/>
	       			<ui:param name="deleteAllowed" value="#{false}"/>
	   			</ui:include>
	  		</h:form>
	  	</t:dataList>
	    <h:outputText rendered="#{jobStatusBean.jobInfo.pipeline}">
			<t:dataList var="child" value="#{jobStatusBean.allSteps}" rowIndexVar="idx">
				<h:outputText rendered="#{idx gt 0}">
		    		<ui:include src="jobStatus_child.xhtml">
				    	<ui:param name="jobInfo" value="#{child}" />
				    </ui:include>
			    </h:outputText>
	    	</t:dataList>
	   	</h:outputText>
	    
	    </div>
	    
	</ui:define>
	
</ui:composition>
</html>
