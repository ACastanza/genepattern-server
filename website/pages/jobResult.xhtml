<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<!-- /*
 The Broad Institute
 SOFTWARE COPYRIGHT NOTICE AGREEMENT
 This software and its documentation are copyright (2003-2008) by the
 Broad Institute/Massachusetts Institute of Technology. All rights are
 reserved.
 
 This software is supplied without any warranty or guaranteed support
 whatsoever. Neither the Broad Institute nor MIT can be responsible for its
 use, misuse, or functionality.
 */ -->

<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:fn="http://java.sun.com/jsp/jstl/functions"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:t="http://myfaces.apache.org/tomahawk"
	xmlns:c="http://java.sun.com/jstl/core">
<ui:composition template="/templates/common.xhtml">
	<ui:define name="pageTitle">
		GenePattern | Job #{jobInfoBean.jobNumber}
	</ui:define>
	<ui:define name="headText">
		<link
			href="#{facesContext.externalContext.requestContextPath}/css/style-jobresults.css"
			rel="stylesheet" type="text/css" />
		<script type="text/javascript"
			src="#{facesContext.externalContext.requestContextPath}/js/collapsiblePanel.js" />
			
		<!-- Script which reloads the page -->
        <t:div rendered="#{jobInfoBean.jobInfoWrapper.status != 'Finished' and jobInfoBean.jobInfoWrapper.status != 'Error'}">
	        <script>
	        function startRefreshTimer() { 
	            var interval = 10000; //millis
	            window.setTimeout(refresh, interval);
	        }
	        function refresh() {
	        window.location.reload();
	        }
	        window.addEventListener("load", startRefreshTimer, false);
	        </script>
	        
	        
        </t:div>
        <script type="text/javascript">
	        
	        function toggleInputParameters() {
	        	var myDiv = document.getElementById("inputParametersDiv");
	        	myDiv.style.display = myDiv.style.display == "none" ? "" : "none"; 
	        }
	        
	        </script>
	</ui:define>

	<ui:define name="body">
	<t:div rendered="#{jobInfoBean.jobInfoWrapper.status != 'Finished' and jobInfoBean.jobInfoWrapper.status != 'Error'}">
		<p>This page will reload every 10 seconds until your job is completed.  <a href="javascript:window.location.reload();">Click here</a> to reload manually.  You may navigate away from this page and your job will still finish.</p>
	</t:div>
	
	<br/>
	<table width="100%"  border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td>
				<a href="#" onclick="document.getElementById('permissionDiv').style.display = (document.getElementById('permissionDiv').style.display == 'none' ? '' : 'none'); document.getElementById('userGroupText').innerHTML = (document.getElementById('userGroupText').innerHTML == 'edit' ? 'hide' : 'edit');"><img border="0" src="/gp/images/group.gif"/> <span id="userGroupText">edit</span> group permissions</a>
				<br/><br/>
			</td>
		</tr>
     	<tr id="permissionDiv" style="display:none;">
			<td>
			<table width="50%" border="0" cellspacing="0" cellpadding="0">
		       	<tr class="tableheader-row">
		       		<th align="left">group</th>
		       		<th>read</th>
		       		<th>read/write</th>
		         	</tr>
		         	<t:dataList value="#{userPrefsBean.groups}" var="group">
		        <tr class="task-titlerow">
		        	<td><h:outputText>#{group}</h:outputText></td>
		        	<td align="center"><input id="perm#{group}R" type="checkbox" value="R"/></td>
		        	<td align="center"><input id="perm#{group}RW" type="checkbox" value="RW"/></td>
				</tr>
				</t:dataList>
				<script> 
					<t:dataList value="#{jobInfoBean.jobInfoWrapper.groupPermissions}" var="gp">
					<h:outputText rendered="#{gp.permission.read}">
						document.getElementById('perm#{gp.groupId}R').checked = true;
					</h:outputText>
					<h:outputText rendered="#{gp.permission.write}">
						document.getElementById('perm#{gp.groupId}RW').checked = true;
					</h:outputText>
					</t:dataList>
				</script>
			</table>     
			<br/><input type='button' value='submit changes' />
			<br/><br/>             
			</td>
		</tr>
     	<tr>
        	<td class="barhead-task">#{jobInfoBean.jobInfoWrapper.taskName} Status </td>
        	
    	</tr>
	</table><br/>
	<table width='100%' cellpadding="0" style="border-bottom: 1px solid gray">
	    <tr>
	      <td width="50px" style="text-align: center">
	      <t:div rendered="#{jobInfoBean.jobInfoWrapper.status != 'Finished' and jobInfoBean.jobInfoWrapper.status != 'Error'}">
          	<img src="/gp/images/runningJob.gif"/>
          </t:div>
          <t:div rendered="#{jobInfoBean.jobInfoWrapper.status == 'Finished'}">
          	<img src="/gp/images/checkbox.gif" height="18"/>
          </t:div>
          <t:div rendered="#{jobInfoBean.jobInfoWrapper.status == 'Error'}">
          	<img src="/gp/images/delete-icon.gif"/>
          </t:div>
          
	  <!--   input name="stopCmd" id="stopCmd" type="button" value="Stop..." onclick="stopJob(this, <%= job.getJobNumber()%>)" class="little" -->
	      </td>
	        <td>
	            <t:div rendered="#{jobInfoBean.jobInfoWrapper.status != 'Finished' and jobInfoBean.jobInfoWrapper.status != 'Error'}">
	            	<h:outputText value="Running #{jobInfoBean.jobInfoWrapper.taskName} as job # #{jobInfoBean.jobNumber} on #{jobInfoBean.dateSubmitted}.">
		                <f:convertDateTime pattern="dd.MM.yyyy HH:mm" />
		            </h:outputText>
	            </t:div>
				<t:div rendered="#{jobInfoBean.jobInfoWrapper.status == 'Finished' or jobInfoBean.jobInfoWrapper.status == 'Error'}">
		            <h:outputText value="#{jobInfoBean.jobInfoWrapper.status} running #{jobInfoBean.jobInfoWrapper.taskName} as job # #{jobInfoBean.jobNumber} on #{jobInfoBean.dateCompleted}.">
		                <f:convertDateTime pattern="dd.MM.yyyy HH:mm" />
	            	</h:outputText>	
	            </t:div>
	            <div>Elapsed time: #{jobInfoBean.jobInfoWrapper.elapsedTimeMillis} ms</div>
	            <div><a href="#" onclick='window.open("#{facesContext.externalContext.requestContextPath}/pages/jobInfo.jsf?target=new&amp;jobNumber=#{jobInfoBean.jobNumber}", "Job #{jobInfoBean.jobNumber}","toolbar=no, location=no, status=no, resizable=yes, scrollbars=yes, menubar=no, width=550, height=300");return false'>click to view input parameters</a></div>
	            </td></tr>
	            <tr><td>&nbsp;</td><td>
	            <h:outputText rendered="#{!empty jobInfoBean.jobInfoWrapper.outputFiles}">
				 	<table>
				 	<tr><td style="vertical-align: top">
				    <b>Output Files:</b>
				    </td><td style="vertical-align: top">
					    <ol>
					        <t:dataList var="p" value="#{jobInfoBean.jobInfoWrapper.outputFiles}">
					            <li><h:outputText>
					                <a href="#{facesContext.externalContext.requestContextPath}/jobResults/#{p.jobNumber}/#{p.name}">#{p.name}</a>
					                </h:outputText></li>
					        </t:dataList>
					    </ol>
					</td>
					</tr>
					</table>
			    </h:outputText> 
	        </td>
	    </tr>
	
	<tr><td>&nbsp;</td></tr>
	</table>
	
	<h:outputText rendered="#{fn:length(jobInfoBean.childJobs) gt 0}">
	<div style="margin-left: 25px;">
	<h3>Pipeline steps:</h3>
    <t:dataList var="child" value="#{jobInfoBean.childJobs}" rowIndexVar="rowIndex">
        <table width="100%"  border="0" cellpadding="0" cellspacing="0" class="barhead-task">
     	<tr>
        	<td>#{rowIndex+1}: #{child.taskName} Status </td>
    	</tr>
	</table><br/>
	<table width='100%' cellpadding="0" style="border-bottom: 1px solid gray">
	    <tr>
	      <td width="50px" style="text-align: center">
	      <t:div rendered="#{child.status != 'Finished' and child.status != 'Error'}">
          	<img src="/gp/images/runningJob.gif"/>
          </t:div>
          <t:div rendered="#{child.status == 'Finished'}">
          	<img src="/gp/images/checkbox.gif" height="18"/>
          </t:div>
          <t:div rendered="#{child.status == 'Error'}">
          	<img src="/gp/images/delete-icon.gif"/>
          </t:div>
          
	  <!--   input name="stopCmd" id="stopCmd" type="button" value="Stop..." onclick="stopJob(this, <%= job.getJobNumber()%>)" class="little" -->
	      </td>
	        <td>
	            <t:div rendered="#{child.status != 'Finished' and child.status != 'Error'}">
	            	<h:outputText value="Running #{child.taskName} as job # #{child.jobNumber} on #{child.dateSubmitted}.">
		                <f:convertDateTime pattern="dd.MM.yyyy HH:mm" />
		            </h:outputText>
	            </t:div>
				<t:div rendered="#{child.status == 'Finished' or child.status == 'Error'}">
		            <h:outputText value="#{child.status} running #{child.taskName} as job # #{child.jobNumber} on #{child.dateCompleted}.">
		                <f:convertDateTime pattern="dd.MM.yyyy HH:mm" />
	            	</h:outputText>	
	            </t:div>
	            <div>Elapsed time: #{child.elapsedTimeMillis} ms</div>
	            <div><a href="#" onclick='window.open("#{facesContext.externalContext.requestContextPath}/pages/jobInfo.jsf?target=new&amp;jobNumber=#{child.jobNumber}", "Job #{child.jobNumber}","toolbar=no, location=no, status=no, resizable=yes, scrollbars=yes, menubar=no, width=550, height=300");return false'>click to view input parameters</a></div>
	            </td></tr>
	            <tr><td>&nbsp;</td><td>
	            <h:outputText rendered="#{!empty child.outputFiles}">
				 	<table cellpadding="0">
				 	<tr><td style="vertical-align: top">
				    <b>Output Files:</b>
				    </td><td style="vertical-align: top">
					    <ol>
					        <t:dataList var="p" value="#{child.outputFiles}">
					            <li><h:outputText>
					                <a href="#{facesContext.externalContext.requestContextPath}/jobResults/#{p.jobNumber}/#{p.name}">#{p.name}</a>
					                </h:outputText></li>
					        </t:dataList>
					    </ol>
					</td>
					</tr>
					</table>
			    </h:outputText> 
	        </td>
	    </tr>
	
	<tr><td>&nbsp;</td></tr>
	</table>
    </t:dataList>
    </div>
    </h:outputText>

	</ui:define>
</ui:composition>
</html>
