<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:ui="http://java.sun.com/jsf/facelets" xmlns:h="http://java.sun.com/jsf/html" xmlns:f="http://java.sun.com/jsf/core" xmlns:t="http://myfaces.apache.org/tomahawk" xmlns:c="http://java.sun.com/jstl/core">
  <ui:composition template="/templates/common.xhtml">
    <ui:define name="headText">
      <script type="text/javascript" src="#{facesContext.externalContext.requestContextPath}/js/prototype.js"/>
<script type="text/javascript">
/* <![CDATA[ */
// Execute a jsf el expression on the server
function callManagedBean(elExpression) {            
  var opt = {
    method:    'post',
    postBody:  'el=' + elExpression,
    onSuccess: receiveResponse,
    onFailure: function(t) {
      alert('Error ' + t.status + ' -- ' + t.statusText);
    }
  } 
  new  Ajax.Request('#{facesContext.externalContext.requestContextPath}/anyThingAtAll.ajax',opt);
}

// The callback function - receive response from server
function receiveResponse( req ) {
  if (req.readyState == 4) {
    if (req.status == 200) { // only if "OK"
      update(req.responseText);
    } 
    else {
      alert("There was a problem retrieving the XML data:\n" + req.statusText);
    }  
  }
}


var timerID = 0;

function startPolling(elExpression, interval) {
   callManagedBean( elExpression );
   timerID  = setTimeout("startPolling('" + elExpression + "', " + interval + ")", interval);
}

function stopPolling() {
   if(timerID) {
      clearTimeout(timerID);
      timerID  = 0;
   }
}

/* Update the page from the status objects.  Example jsonString ...
 * [{"lsid":"urn:lsid:broad.mit.edu:cancer.software.genepattern.module.analysis:00030:1","status":true},
 *  {"lsid":"urn:lsid:broad.mit.edu:cancer.software.genepattern.module.analysis:00052:1","status":true},
 *  {"lsid":"urn:lsid:broad.mit.edu:cancer.software.genepattern.module.analysis:00002:1","status":true}]
 */
function update(jsonString)
{
  new Insertion.Bottom("progress_indicator", ".");
  
  var complete = true;
  var objArray = eval('(' + jsonString + ')');
  for(var i=0; i<objArray.length; i++) {
    var installStatus = objArray[i];
    var lsid = installStatus.lsid;
    var cb = $("cb_" + lsid);
    if(installStatus.status == "success") {
       if(cb != null) {
        cb.src="#{facesContext.externalContext.requestContextPath}/images/checkbox.gif";
      }
    }
    else if (installStatus.status == "error") {
      if(cb != null) {
        cb.src="#{facesContext.externalContext.requestContextPath}/images/red-x.gif";
      }
        var errorDivId = "error_" + lsid;
        Element.show(errorDivId);
        Element.update(errorDivId, "<p>" + installStatus.message + "</p>");
    }
    else {
      complete = false;
    }
  }
  
  if(complete == true) {
  
    Element.update("progress_indicator", "<i>done</i>")
  
    stopPolling();
    var buttonPane = $("button_pane");
    if(buttonPane != null) { 
      Element.show(buttonPane);
    }
  }
}
		
/* ]]> */
</script>
    </ui:define>
    <ui:define name="pageTitle">GenePattern | Installing  Tasks</ui:define>
    <ui:define name="body">
      <script type="text/javascript">
        startPolling("taskInstallBean.installedTaskString", 500);
        
      </script>

      <h:form>
        <p>
          <h1>Installing Tasks&#160;&#160;<span id="progress_indicator"></span> </h1>
        </p>
        
        <table>
          <!--  Loop through tasks (TaskInstallStatus beans) -->
          <ui:repeat var="task" value="#{taskInstallBean.tasks}">
            <tr>
              <td>
                #{task.name}
              </td>
              <td>
                <img src="#{facesContext.externalContext.requestContextPath}/images/spacer.gif" width="12" height="12" id="cb_#{task.lsid}"/>
              </td>
            </tr>
          </ui:repeat>
        </table>
        
        <!--  Divs for error messages.  One for each task  -->
        <ui:repeat var="task" value="#{taskInstallBean.tasks}">
          <div id="error_#{task.lsid}" class="validation-error" style="display: none;">
             
          </div>
        </ui:repeat>
        

        <div id="button_pane" style="display: none;">
          <t:commandButton value="Done"  action="home"/>&#160;
          <t:commandButton value="Install More" action="task catalog"/>
        </div>
      </h:form>
    </ui:define>
  </ui:composition>
</html>
