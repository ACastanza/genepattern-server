<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:t="http://myfaces.apache.org/tomahawk"
	xmlns:c="http://java.sun.com/jstl/core">


<ui:composition template="/templates/common.xhtml">
	<ui:define name="headText">
		<script type="text/javascript"
			src="#{facesContext.externalContext.requestContextPath}/js/prototype.js"></script>
		<script type="text/javascript" language="javascript">
<h:outputText>
	var requiredIds = new Array();
	var requiredNames = new Array();
</h:outputText>
<t:dataList value="#{runTaskBean.parameters}" var="p" rowIndexVar="i">
    <h:outputText rendered = "#{p.optional==false}">
	requiredIds['#{i}'] = '#{p.name}';
    requiredNames['#{i}'] = '#{p.displayName}';
	</h:outputText>
 </t:dataList>
 
/* <![CDATA[ */

	function callManagedBean(elExpression, parameters) {            
        var opt = {
          parameters: parameters + '&el=' + elExpression,
          onSuccess: receiveResponse,
          onFailure: function(t) {
            alert('Error ' + t.status + ' -- ' + t.statusText);
          }
        } 
        new  Ajax.Request('#{facesContext.externalContext.requestContextPath}/anyThingAtAll.ajax',opt);
      }

      // The callback function - receive response from server
      function receiveResponse( req ) {
        if (req.readyState == 4) {
          if (req.status == 200) { // only if "OK"
            alert(req.responseText);
          } 
          else {
            alert("There was a problem retrieving the XML data:\n" + req.statusText);
          }  
        }
      }
      
function exportPipeline(lsid, title) {
	var width = 250;
	var height = 200;
	var exportWindow = window.open('askInclude.jsp?name=' + 
		    lsid +   
		    '&title=' + title, 
		    'export',
		    'alwaysRaised=yes,height=' + height + ',width=' + width + ',menubar=no,location=no,resizable=yes,scrollbars=yes,directories=no,status=no,toolbar=no');
	exportWindow.focus();
}	
	
function viewCode() {
	var selector = $('gp_languageSelector');
	if(selector.selectedIndex==0) {
		window.alert('Please select a language');
		return false;
	}
	var form = $('taskForm');
	
	var params = 'language=' + selector.options[selector.selectedIndex].value;
	for(var i = 0; i < form.elements.length; i++) {
		var e = form.elements[i];
		if(e.name!='gp_languageSelector') {
			params += "&" + e.name + "=" + e.value;
		}
	}
	callManagedBean("recentJobsBean.taskCode", params);
	
}

function validateForm() {
        var error = false;
        var missingParams = "<br/>";
        for(var i = 0; i < requiredIds.length; i++) {
            var elementId = requiredIds[i];   
            var displayName = requiredNames[i];          
            var e = $(elementId);
            var type = e.type;
            
            if (type == "file" || type == "text" || type == "textarea") {
                var value = e.value;
                if (value == null || value == "") {
                   error = true;
                   missingParams += "<br/>" + "<b>" + displayName + "</b>";
                }
            }
        }
       
        var d = $("errorMessageDiv");
        var t = $("errorMessage");
        
        if (error) {
            d.style.display = "inline";
            t.innerHTML =
            "<font color=\"red\" size=\"+1\">The task could not be run. The following required parameters need to have values provided:</font>" +
            missingParams;
        } else {
            d.style.display = "hidden";
        }
        
        return !error;
    }

     
function chooserModeChanged() {	  
   var radioPanel = document.getElementById("viewchoiceRadioPanel");
   var radioButtons = radioPanel.getElementsByTagName("input");
   for(var i=0; i<radioButtons.length; i++) {
     if(radioButtons[i].type == "radio") {
       var panelId  = "module_table_" + radioButtons[i].value;
       var panel = document.getElementById(panelId);
       if(radioButtons[i].checked && panel != null) {
         Element.show(panel);
       }
       else {
         Element.hide(panel);
       }
     }
   }
}
   


/* ]]> */

</script>

	</ui:define>

	<ui:define name="pageTitle">
	  GenePattern 
	  <h:outputText rendered="#{!empty runTaskBean.lsid}"> - #{runTaskBean.name}</h:outputText>
	</ui:define>


	<ui:define name="leftPanel">
		<td width="242" rowspan="2" valign="top" class="tasks" id="tasks">
		<ui:include src="moduleChooser.xhtml" /></td>
	</ui:define>

	<ui:define name="rightPanel">
		<td width="203" rowspan="2" valign="top" class="recentjobs"
			id="recentjobs"><ui:include src="recentJobs.xhtml" /></td>
	</ui:define>

	

	<ui:define name="body">
		<div id="errorMessageDiv" style="display:none;">
		<p id="errorMessage"></p>
		</div>

		<c:choose>
			<c:when test="#{!empty runTaskBean.lsid}">
				<table width="100%" border="0" cellpadding="0" cellspacing="0"
					class="barhead-task">
					<tr>
						<td>#{runTaskBean.name}</td>
						<td align="right"><span class="barhead-version">version
						#{runTaskBean.version} &#160;</span> <h:outputText
							rendered="#{!empty runTaskBean.versions}">
							
						</h:outputText> <h:outputText rendered="#{!empty runTaskBean.versions}">
							<img
								src="#{facesContext.externalContext.requestContextPath}/images/menuicon-2.gif"
								name="Image_versionPopupMenu" id="Image_versionPopupMenu"
								width="14" height="14" border="0" valign="middle"
								onclick="pm_showMenu('versionPopupMenu', Position.cumulativeOffset(this), 0, 0);"
								onmouseover="MM_swapImage('Image_versionPopupMenu','','#{facesContext.externalContext.requestContextPath}/images/menuicon-over.gif',2)"
								onmouseout="MM_swapImgRestore();" />
							<br />


						</h:outputText></td>
					</tr>
				</table>


				<form
					action="#{facesContext.externalContext.requestContextPath}/#{runTaskBean.formAction}"
					method="post" id="taskForm" enctype="multipart/form-data"
					onsubmit="return validateForm();"><input type="hidden"
					name="taskLSID" value="#{runTaskBean.lsid}" /> <input
					type="hidden" name="taskName" value="#{runTaskBean.name}" />



				<table border="0" cellpadding="5" cellspacing="0" class="attribute"
					valign="top">
					<tbody>


						<tr class="taskperameter">
							<td><span class="description"><c:if
								test="#{runTaskBean.inputParametersExist}">* required field</c:if></span></td>
							<td colspan="2" class="maintasknav2"><input name="cmd"
								value="run" type="submit" /> <input name="reset" value="reset"
								onclick="window.location.href=window.location.href"
								type="button" /> &#160;&#160;<a
								href="#{facesContext.externalContext.requestContextPath}/viewTask.jsp?name=#{runTaskBean.lsid}">properties</a>

							&#160;|&#160; <h:outputText rendered="#{runTaskBean.pipeline}">

								<a
									onclick="exportPipeline('#{runTaskBean.lsid}', '#{runTaskBean.name}');">export</a>
										&#160;|&#160;
									<a
									href="#{facesContext.externalContext.requestContextPath}/pipelineDesigner.jsp?name=#{runTaskBean.lsid}">edit</a>
							</h:outputText> <h:outputText rendered="#{!runTaskBean.pipeline}">
								<a
									href="#{facesContext.externalContext.requestContextPath}/makeZip.jsp?name=#{runTaskBean.lsid}">export</a>
									&#160;|&#160;
									<a
									href="#{facesContext.externalContext.requestContextPath}/addTask.jsp?name=#{runTaskBean.lsid}">edit</a>

							</h:outputText> &#160;|&#160;<a target="_blank"
								href="#{facesContext.externalContext.requestContextPath}/getTaskDoc.jsp?name=#{runTaskBean.lsid}">help</a>
							</td>
						</tr>

						<t:dataList value="#{runTaskBean.parameters}" var="p">
							<tr class="taskperameter">
								<td valign="top"
									class="#{p.optional==false ? 'attribute-required' : ''}">
								<nobr> #{p.displayName} <h:outputText
									rendered="#{p.optional==false}" value="*"></h:outputText> </nobr></td>

								<td valign="top"><h:outputText
									rendered="#{p.inputType=='file'}">

									<input name="#{p.name}" id="#{p.name}" size="30"
										type="#{p.inputType}"
										onchange="this.form['shadow#{p.name}'].value=this.value;"
										onblur="javascript:if (this.value.length
							> 0) { this.form['shadow#{p.name}'].value=this.value;
							}"
										ondrop="this.form['shadow#{p.name}'].value=this.value;" />
									<input name="shadow#{p.name}" type="hidden" readonly="true"
										size="90" tabindex="-1" class="shadow"
										style="{ border-style: none; font-style: italic; font-size:9pt; background-color: transparent }" />
								</h:outputText> <h:outputText rendered="#{p.inputType=='select'}">
									<select name="#{p.name}" id="#{p.name}">
										<t:dataList value="#{p.choices}" var="c">

											<h:outputText rendered="#{c.selected}">
												<option value="#{c.value}" selected="true">#{c.label}</option>
											</h:outputText>>
													<h:outputText rendered="#{!c.selected}">
												<option value="#{c.value}">#{c.label}</option>
											</h:outputText>

										</t:dataList>
									</select>
								</h:outputText> <h:outputText
									rendered="#{p.inputType=='text' || p.inputType=='password'}">
									<input name="#{p.name}" id="#{p.name}" size="30"
										type="#{p.inputType}" value="#{p.defaultValue}" />
								</h:outputText></td>
								<td valign="top" class="description">#{p.displayDescription}</td>
							</tr>

						</t:dataList>

						<h:outputText rendered="#{!empty runTaskBean.parameters}">
							<tr>
								<td>&#160;</td>
								<td colspan="2" class="maintasknav2"><input name="cmd"
									value="run" type="submit" /> <input name="reset" value="reset"
									onclick="window.location.href=window.location.href"
									type="button" /> &#160;&#160;<a
									href="#{facesContext.externalContext.requestContextPath}/viewTask.jsp?name=#{runTaskBean.lsid}">properties</a>
								&#160;|&#160; <h:outputText rendered="#{runTaskBean.pipeline}">
									<a
										onclick="exportPipeline('#{runTaskBean.lsid}', '#{runTaskBean.name}');">export</a>&#160;|&#160;
										<a
										href="#{facesContext.externalContext.requestContextPath}/pipelineDesigner.jsp?name=#{runTaskBean.lsid}">edit</a>
								</h:outputText><h:outputText rendered="#{!runTaskBean.pipeline}">
									<a
										href="#{facesContext.externalContext.requestContextPath}/makeZip.jsp?name=#{runTaskBean.lsid}">export</a>
										&#160;|&#160;
										<a
										href="#{facesContext.externalContext.requestContextPath}/addTask.jsp?name=#{runTaskBean.lsid}">edit</a>
								</h:outputText> &#160;|&#160;<a target="_blank"
									href="#{facesContext.externalContext.requestContextPath}/getTaskDoc.jsp?name=#{runTaskBean.lsid}">help</a>
								</td>
							</tr>
						</h:outputText>

					</tbody>
				</table>

				<p>&#160;</p>

				<br />
				<div class="download_code"><strong>Download code to
				call #{runTaskBean.name}: </strong>
				<p></p>

				<select name="gp_languageSelector" id="gp_languageSelector">
					<option selected="selected">- Language -</option>
					<option>Java</option>
					<option>MATLAB</option>
					<option>R</option>
				</select> &#160; <input type="button" onclick="viewCode();" value="View Code" /></div>
				</form>
			</c:when>

			<c:otherwise>
				<c:choose>
					<c:when test="#{runTaskBean.splashMessage != null}">
						<p />
						<h3>#{runTaskBean.splashMessage}</h3>
					</c:when>
					<c:otherwise>
						<ui:include src="splashpage.xhtml" />
					</c:otherwise>
				</c:choose>
			</c:otherwise>
		</c:choose>
	</ui:define>
	
	<ui:define name="popupMenus">
	<script type="text/javascript">
		pm_popupMenuIds.push('versionPopupMenu');
	</script>
		<h:form>
			<div id="versionPopupMenu" style="visibility:hidden; position:absolute;" class="popupMenu">
			<table>
				<tbody>
					<tr>
						<t:dataList value="#{runTaskBean.versions}" var="version">
							<tr>
								<td><h:commandLink value="#{version}"
									action="#{runTaskBean.changeVersion}">
									<f:param value="#{version}" name="version" />
								</h:commandLink></td>
							</tr>
						</t:dataList>
					</tr>
				</tbody>
			</table>
			</div>
		</h:form>
	</ui:define>
	
</ui:composition>
</html>
